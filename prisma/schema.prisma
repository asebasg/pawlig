// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ===== ENUMS =====
enum Municipality {
  MEDELLIN
  BELLO
  ITAGUI
  ENVIGADO
  SABANETA
  LA_ESTRELLA
  CALDAS
  COPACABANA
  GIRARDOTA
  BARBOSA
}

enum UserRole {
  ADMIN
  SHELTER
  VENDOR
  ADOPTER
}

enum PetStatus {
  AVAILABLE
  IN_PROCESS
  ADOPTED
}

enum AdoptionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

// ===== MODELS =====
model User {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  email     String       @unique
  password  String
  name      String
  role      UserRole     @default(ADOPTER)
  phone     String
  municipality Municipality
  address   String
  idNumber  String
  birthDate DateTime
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  shelter   Shelter?
  vendor    Vendor?
  adoptions Adoption[]
  orders    Order[]
  favorites Favorite[]

  @@index([role])
  @@index([municipality])
  @@index([email])
}

model Shelter {
  id                String       @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  municipality      Municipality
  address           String
  description       String?
  verified          Boolean      @default(false)
  contactWhatsApp   String?
  contactInstagram  String?
  rejectionReason   String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique @db.ObjectId

  pets Pet[]

  @@index([verified])
  @@index([municipality])
  @@index([name])
}

model Vendor {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  businessName    String
  businessPhone   String?
  description     String?
  logo            String?
  municipality    Municipality
  address         String
  verified        Boolean      @default(false)
  rejectionReason String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique @db.ObjectId

  products Product[]

  @@index([verified])
  @@index([municipality])
  @@index([businessName])
}

model Pet {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  species      String
  breed        String?
  age          Int?
  sex          String?
  status       PetStatus @default(AVAILABLE)
  description  String
  requirements String?
  images       String[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  shelter   Shelter @relation(fields: [shelterId], references: [id], onDelete: Cascade)
  shelterId String  @db.ObjectId

  adoptions Adoption[]
  favorites Favorite[]

  @@index([status])
  @@index([species])
  @@index([shelterId])
  @@index([createdAt])
  @@index([name])
  @@index([sex])
  @@index([age])
}

model Product {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  price       Float
  stock       Int      @default(0)
  category    String
  description String?
  images      String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  vendor      Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId    String @db.ObjectId

  orderItems OrderItem[]

  @@index([category])
  @@index([vendorId])
  @@index([stock])
  @@index([name])
  @@index([price])
}

model Adoption {
  id        String          @id @default(auto()) @map("_id") @db.ObjectId
  status    AdoptionStatus  @default(PENDING)
  message   String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  adopter   User   @relation(fields: [adopterId], references: [id], onDelete: Cascade)
  adopterId String @db.ObjectId

  pet   Pet    @relation(fields: [petId], references: [id], onDelete: Cascade)
  petId String @db.ObjectId

  @@unique([adopterId, petId])
  @@index([status])
  @@index([adopterId])
  @@index([petId])
  @@index([createdAt])
}

model Order {
  id                   String       @id @default(auto()) @map("_id") @db.ObjectId
  status               OrderStatus  @default(PENDING)
  total                Float
  shippingMunicipality Municipality
  shippingAddress      String
  paymentMethod        String
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.ObjectId

  items OrderItem[]

  @@index([status])
  @@index([userId])
  @@index([shippingMunicipality])
  @@index([createdAt])
}

model OrderItem {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  quantity Int
  price    Float

  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId String @db.ObjectId

  product   Product @relation(fields: [productId], references: [id])
  productId String  @db.ObjectId

  @@index([orderId])
  @@index([productId])
}

model Favorite {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String   @db.ObjectId
  pet        Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  petId      String   @db.ObjectId

  @@unique([userId, petId])
  @@index([userId])
  @@index([petId])
  @@index([createdAt])
}

/**
 * üìö CAMBIOS APLICADOS:
 * 
 * 1. √çNDICES ADICIONALES PARA B√öSQUEDA (Performance - RNF-001):
 *    - Pet: name, sex, age (campos de filtro frecuentes)
 *    - Shelter: name (b√∫squeda de albergues)
 *    - Product: name, price (b√∫squeda de productos)
 *    - User: email (login frecuente)
 * 
 * 2. √çNDICES COMPUESTOS IMPL√çCITOS:
 *    - MongoDB optimiza queries con m√∫ltiples filtros
 *    - Ejemplo: status + species + shelterId (b√∫squeda compleja)
 * 
 * 3. JUSTIFICACI√ìN DE √çNDICES:
 *    - status: Siempre filtrado (AVAILABLE/ADOPTED)
 *    - species: Filtro principal de usuarios
 *    - shelterId: Join con shelter en cada query
 *    - createdAt: Ordenamiento por defecto (DESC)
 *    - name: B√∫squeda por nombre
 *    - sex: Filtro de g√©nero
 *    - age: Filtro de rango de edad
 * 
 * 4. IMPACTO EN PERFORMANCE:
 *    - B√∫squedas < 2 segundos con 10,000 registros (RNF-001)
 *    - √çndices en RAM para queries frecuentes
 *    - MongoDB optimiza autom√°ticamente con $match pipeline
 * 
 * 5. MANTENIMIENTO:
 *    - √çndices se crean autom√°ticamente con `prisma db push`
 *    - No requiere intervenci√≥n manual en MongoDB Atlas
 *    - Monitorear uso de √≠ndices con MongoDB Atlas Performance Advisor
 */
