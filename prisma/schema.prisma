// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ===== ENUMS =====
enum Municipality {
  MEDELLIN
  BELLO
  ITAGUI
  ENVIGADO
  SABANETA
  LA_ESTRELLA
  CALDAS
  COPACABANA
  GIRARDOTA
  BARBOSA
}

enum UserRole {
  ADMIN
  SHELTER
  VENDOR
  ADOPTER
}

enum PetStatus {
  AVAILABLE
  IN_PROCESS
  ADOPTED
}

enum AdoptionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

// ===== MODELS =====
model User {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  email       String       @unique
  password    String
  name        String
  role        UserRole     @default(ADOPTER)
  phone       String
  municipality Municipality
  address     String
  idNumber    String
  birthDate   DateTime
  
  // Bloqueos de usuarios
  isActive    Boolean      @default(true) // Indica si la cuenta est√° activa
  blockedAt   DateTime?    // Fecha de bloqueo
  blockedBy   String?      @db.ObjectId // ID del admin que bloque√≥
  blockReason String?      // Motivo del bloqueo
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relaciones existentes
  shelter     Shelter?
  vendor      Vendor?
  adoptions   Adoption[]
  orders      Order[]
  favorites   Favorite[]
  
  // Auditor√≠a de acciones administrativas
  adminActions UserAudit[] @relation("AdminActions") // Acciones realizadas por este admin
  auditRecords UserAudit[] @relation("AffectedUser") // Auditor√≠as donde este usuario fue afectado

  @@index([role])
  @@index([isActive]) // √çndice para filtrar usuarios activos/bloqueados
  @@index([municipality])
}

model UserAudit {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Acci√≥n realizada
  action      String   // "BLOCK", "UNBLOCK", "CHANGE_ROLE", "DELETE"
  reason      String   // Justificaci√≥n obligatoria
  
  // Datos anteriores y nuevos (para trazabilidad)
  oldValue    String?  // Valor anterior (ej: "ADOPTER" en cambio de rol)
  newValue    String?  // Valor nuevo (ej: "VENDOR" en cambio de rol)
  
  // Relaciones
  performedBy User     @relation("AdminActions", fields: [adminId], references: [id], onDelete: Cascade)
  adminId     String   @db.ObjectId
  
  affectedUser User    @relation("AffectedUser", fields: [userId], references: [id], onDelete: Cascade)
  userId      String   @db.ObjectId
  
  // Metadata
  ipAddress   String?  // IP del admin (seguridad adicional)
  userAgent   String?  // Navegador del admin
  
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

model Shelter {
  id                String       @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  nit               String       @unique  // NIT √∫nico del albergue (DANE)
  municipality      Municipality
  address           String
  description       String?
  verified          Boolean      @default(false)
  contactWhatsApp   String?
  contactInstagram  String?
  rejectionReason   String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique @db.ObjectId

  pets Pet[]

  @@index([verified])
  @@index([municipality])
}

model Vendor {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  businessName    String
  businessPhone   String?
  description     String?
  logo            String?
  municipality    Municipality
  address         String
  verified        Boolean      @default(false)
  rejectionReason String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique @db.ObjectId

  products Product[]

  @@index([verified])
  @@index([municipality])
}

model Pet {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  species      String
  breed        String?
  age          Int?
  sex          String?
  status       PetStatus @default(AVAILABLE)
  description  String
  requirements String?
  images       String[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  shelter   Shelter @relation(fields: [shelterId], references: [id], onDelete: Cascade)
  shelterId String  @db.ObjectId

  adoptions Adoption[]
  favorites Favorite[]

  @@index([status])
  @@index([species])
  @@index([shelterId])
  @@index([createdAt])
}

model Product {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  price       Float
  stock       Int      @default(0)
  category    String
  description String?
  images      String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  vendor      Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId    String @db.ObjectId

  orderItems OrderItem[]

  @@index([category])
  @@index([vendorId])
  @@index([stock])
}

model Adoption {
  id        String          @id @default(auto()) @map("_id") @db.ObjectId
  status    AdoptionStatus  @default(PENDING)
  message   String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  adopter   User   @relation(fields: [adopterId], references: [id], onDelete: Cascade)
  adopterId String @db.ObjectId

  pet   Pet    @relation(fields: [petId], references: [id], onDelete: Cascade)
  petId String @db.ObjectId

  @@unique([adopterId, petId])
  @@index([status])
  @@index([adopterId])
  @@index([petId])
}

model Order {
  id                   String       @id @default(auto()) @map("_id") @db.ObjectId
  status               OrderStatus  @default(PENDING)
  total                Float
  shippingMunicipality Municipality
  shippingAddress      String
  paymentMethod        String
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.ObjectId

  items OrderItem[]

  @@index([status])
  @@index([userId])
  @@index([shippingMunicipality])
  @@index([createdAt])
}

model OrderItem {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  quantity Int
  price    Float

  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId String @db.ObjectId

  product   Product @relation(fields: [productId], references: [id])
  productId String  @db.ObjectId

  @@index([orderId])
  @@index([productId])
}

model Favorite {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String   @db.ObjectId
  pet        Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  petId      String   @db.ObjectId

  @@unique([userId, petId])
  @@index([userId])
  @@index([petId])
  @@index([createdAt])
}

/**
 * üìö CAMBIOS REALIZADOS EN EL SCHEMA:
 * 
 * 1. MODELO SHELTER - CAMPO NIT:
 *    - Agregado: nit String @unique
 *    - Tipo: String (permite NITs con guiones: "900.123.456-7")
 *    - Constraint: @unique (garantiza unicidad a nivel de base de datos)
 *    - √çndice: @@index([nit]) para b√∫squedas r√°pidas
 * 
 * 2. JUSTIFICACI√ìN DEL CAMPO NIT:
 *    - NIT = N√∫mero de Identificaci√≥n Tributaria (Colombia)
 *    - Emitido por DANE para identificar entidades legales
 *    - √önico por establecimiento/organizaci√≥n
 *    - Requerido para validar legalidad del albergue
 * 
 * 3. FORMATO DEL NIT:
 *    - 9 d√≠gitos + d√≠gito de verificaci√≥n
 *    - Ejemplo: "900123456-7" o "900.123.456-7"
 *    - Almacenado como String para preservar formato
 * 
 * 4. COMPATIBILIDAD CON DATOS EXISTENTES:
 *    - Si ya hay registros Shelter sin NIT ‚Üí La migraci√≥n fallar√°
 *    - Soluci√≥n: Eliminar shelters existentes o agregar NITs manualmente
 *    - Recomendaci√≥n: Entorno de desarrollo limpio
 * 
 * 5. RELACIONES NO AFECTADAS:
 *    ‚úÖ User ‚Üí Shelter (1:1) - Sin cambios
 *    ‚úÖ Shelter ‚Üí Pet (1:N) - Sin cambios
 *    ‚úÖ Vendor, Product, Order, Adoption - Sin cambios
 * 
 * 6. √çNDICES AGREGADOS:
 *    - @@index([nit]) para b√∫squedas r√°pidas por NIT
 *    - √ötil para validar NIT duplicado en solicitudes
 * 
 * 7. IMPACTO EN EL C√ìDIGO:
 *    - Formulario de solicitud debe incluir campo NIT
 *    - Validaci√≥n con Zod debe incluir regex de NIT
 *    - API Route debe validar formato de NIT
 */
 