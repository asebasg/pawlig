// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ===== ENUMS =====
enum Municipality {
  MEDELLIN
  BELLO
  ITAGUI
  ENVIGADO
  SABANETA
  LA_ESTRELLA
  CALDAS
  COPACABANA
  GIRARDOTA
  BARBOSA
}

enum UserRole {
  ADMIN
  SHELTER
  VENDOR
  ADOPTER
}

enum PetStatus {
  AVAILABLE
  IN_PROCESS
  ADOPTED
}

enum AdoptionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

// ===== MODELS =====
model User {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  email     String       @unique
  password  String
  name      String
  role      UserRole     @default(ADOPTER)
  phone     String
  municipality Municipality
  address   String
  idNumber  String
  birthDate DateTime
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  shelter   Shelter?
  vendor    Vendor?
  adoptions Adoption[]
  orders    Order[]
  favorites Favorite[]

  @@index([role])
  @@index([municipality])
}

model Shelter {
  id                String       @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  nit               String?      // üÜï NUEVO: NIT del albergue (opcional, √∫nico si existe)
  municipality      Municipality
  address           String
  description       String?
  verified          Boolean      @default(false) // ‚ö†Ô∏è Estado inicial: Pendiente de aprobaci√≥n
  contactWhatsApp   String?
  contactInstagram  String?
  rejectionReason   String?      // üÜï Motivo si fue rechazado
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique @db.ObjectId

  pets Pet[]

  @@unique([nit]) // üÜï NUEVO: √çndice √∫nico para NIT (si existe)
  @@index([verified])
  @@index([municipality])
}

model Vendor {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  businessName    String
  businessPhone   String?
  description     String?
  logo            String?
  municipality    Municipality
  address         String
  verified        Boolean      @default(false)
  rejectionReason String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique @db.ObjectId

  products Product[]

  @@index([verified])
  @@index([municipality])
}

model Pet {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  species      String
  breed        String?
  age          Int?
  sex          String?
  status       PetStatus @default(AVAILABLE)
  description  String
  requirements String?
  images       String[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  shelter   Shelter @relation(fields: [shelterId], references: [id], onDelete: Cascade)
  shelterId String  @db.ObjectId

  adoptions Adoption[]
  favorites Favorite[]

  @@index([status])
  @@index([species])
  @@index([shelterId])
  @@index([createdAt])
}

model Product {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  price       Float
  stock       Int      @default(0)
  category    String
  description String?
  images      String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  vendor      Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId    String @db.ObjectId

  orderItems OrderItem[]

  @@index([category])
  @@index([vendorId])
  @@index([stock])
}

model Adoption {
  id        String          @id @default(auto()) @map("_id") @db.ObjectId
  status    AdoptionStatus  @default(PENDING)
  message   String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  adopter   User   @relation(fields: [adopterId], references: [id], onDelete: Cascade)
  adopterId String @db.ObjectId

  pet   Pet    @relation(fields: [petId], references: [id], onDelete: Cascade)
  petId String @db.ObjectId

  @@unique([adopterId, petId])
  @@index([status])
  @@index([adopterId])
  @@index([petId])
}

model Order {
  id                   String       @id @default(auto()) @map("_id") @db.ObjectId
  status               OrderStatus  @default(PENDING)
  total                Float
  shippingMunicipality Municipality
  shippingAddress      String
  paymentMethod        String
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.ObjectId

  items OrderItem[]

  @@index([status])
  @@index([userId])
  @@index([shippingMunicipality])
  @@index([createdAt])
}

model OrderItem {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  quantity Int
  price    Float

  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId String @db.ObjectId

  product   Product @relation(fields: [productId], references: [id])
  productId String  @db.ObjectId

  @@index([orderId])
  @@index([productId])
}

model Favorite {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String   @db.ObjectId
  pet        Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  petId      String   @db.ObjectId

  @@unique([userId, petId])
  @@index([userId])
  @@index([petId])
  @@index([createdAt])
}

/**
 * üìö CAMBIOS APLICADOS AL SCHEMA (para HU-002):
 * 
 * 1. MODELO SHELTER - CAMPOS NUEVOS:
 *    a) nit (String?, opcional):
 *       - N√∫mero de Identificaci√≥n Tributaria del albergue
 *       - Opcional porque albergues peque√±os pueden no tener
 *       - Si existe, debe ser √∫nico en toda la base de datos
 *       - Formato validado en Zod: /^[0-9-]+$/
 *    
 *    b) rejectionReason (String?, opcional):
 *       - Campo para almacenar el motivo si la solicitud es rechazada
 *       - Obligatorio al rechazar (validado en backend)
 *       - Enviado por email al solicitante (RN-018)
 *       - Permite auditor√≠a de decisiones administrativas
 * 
 * 2. √çNDICES AGREGADOS:
 *    @@unique([nit]):
 *      - Garantiza que no haya dos albergues con el mismo NIT
 *      - Solo aplica si el campo tiene valor (nullable unique)
 *      - Mejora performance en b√∫squedas por NIT
 * 
 * 3. CAMPO EXISTENTE MODIFICADO:
 *    verified (Boolean, default: false):
 *      - Ya exist√≠a en el schema original
 *      - Ahora se usa expl√≠citamente para el flujo de aprobaci√≥n
 *      - false = Pendiente de aprobaci√≥n (estado inicial)
 *      - true = Aprobado por administrador
 * 
 * 4. FLUJO DE ESTADOS DEL ALBERGUE (HU-002):
 *    Estado 1: Solicitud enviada
 *      verified = false
 *      rejectionReason = null
 *    
 *    Estado 2a: Aprobado
 *      verified = true
 *      rejectionReason = null (limpiado)
 *    
 *    Estado 2b: Rechazado
 *      verified = false (sin cambio)
 *      rejectionReason = "motivo del administrador"
 * 
 * 5. TRAZABILIDAD:
 *    - HU-002: Solicitud y aprobaci√≥n de cuenta de albergue ‚úÖ
 *    - RF-007: Administraci√≥n de albergues ‚úÖ
 *    - RN-004: Aprobaci√≥n requerida por administrador ‚úÖ
 *    - RN-017: Justificaci√≥n obligatoria para rechazos ‚úÖ
 *    - RN-018: Notificaci√≥n al usuario afectado ‚úÖ
 * 
 * 6. COMPATIBILIDAD CON C√ìDIGO EXISTENTE:
 *    - El campo `nit` es opcional (String?), no rompe registros existentes
 *    - El campo `rejectionReason` es opcional, compatible con albergues ya aprobados
 *    - El campo `verified` ya exist√≠a, solo se documenta su uso
 *    - No se eliminan ni modifican campos existentes
 * 
 * 7. MIGRACIONES NECESARIAS:
 *    Despu√©s de aplicar estos cambios, ejecutar:
 *      npx prisma generate           # Regenerar cliente Prisma
 *      npx prisma db push            # Aplicar cambios a MongoDB
 *    
 *    MongoDB autom√°ticamente:
 *      - Agrega campos nuevos como opcionales
 *      - Crea √≠ndice √∫nico para `nit`
 *      - No afecta documentos existentes
 * 
 * 8. VALIDACIONES EN C√ìDIGO:
 *    Backend valida:
 *      - NIT √∫nico antes de crear Shelter (evita duplicados)
 *      - Motivo obligatorio al rechazar (RN-017)
 *      - Solo ADMIN puede aprobar/rechazar
 *    
 *    Frontend valida:
 *      - Formato de NIT (solo n√∫meros y guiones)
 *      - Al menos un m√©todo de contacto (RN-013)
 * 
 * 9. NOTAS IMPORTANTES:
 *    ‚ö†Ô∏è MongoDB no soporta constraints CHECK como SQL
 *    ‚ö†Ô∏è La validaci√≥n de "al menos un contacto" se hace en Zod
 *    ‚ö†Ô∏è El √≠ndice @@unique([nit]) solo funciona si nit tiene valor
 *    ‚ö†Ô∏è Los campos opcionales (?) pueden ser null o undefined
 */
