// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ===== ENUMS =====
enum Municipality {
  MEDELLIN
  BELLO
  ITAGUI
  ENVIGADO
  SABANETA
  LA_ESTRELLA
  CALDAS
  COPACABANA
  GIRARDOTA
  BARBOSA
}

enum UserRole {
  ADMIN
  SHELTER
  VENDOR
  ADOPTER
}

enum AuditAction {
  BLOCK
  UNBLOCK
  CHANGE_ROLE
  DELETE
}

enum PetStatus {
  AVAILABLE
  IN_PROCESS
  ADOPTED
}

enum AdoptionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

// ===== MODELS =====

model UserAudit {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Acci√≥n realizada (HU-014, CP-015)
  action      String   // "BLOCK", "UNBLOCK", "CHANGE_ROLE", "DELETE"
  reason      String   // Justificaci√≥n obligatoria (RN-017)
  
  // Datos anteriores y nuevos (trazabilidad)
  oldValue    String?  // Valor anterior (ej: "ADOPTER" en cambio de rol)
  newValue    String?  // Valor nuevo (ej: "VENDOR" en cambio de rol)
  
  // Relaciones
  performedBy User     @relation("AdminActions", fields: [adminId], references: [id], onDelete: Cascade)
  adminId     String   @db.ObjectId
  
  affectedUser User    @relation("AffectedUser", fields: [userId], references: [id], onDelete: Cascade)
  userId      String   @db.ObjectId
  
  // Metadata de seguridad
  ipAddress   String?  // IP del admin (seguridad adicional)
  userAgent   String?  // Navegador del admin
  
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

model User {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  email       String       @unique
  password    String
  name        String
  role        UserRole     @default(ADOPTER)
  phone       String
  municipality Municipality
  address     String
  idNumber    String
  birthDate   DateTime
  
  // Bloqueos de usuarios
  isActive    Boolean      @default(true) // Indica si la cuenta est√° activa
  blockedAt   DateTime?    // Fecha de bloqueo
  blockedBy   String?      @db.ObjectId // ID del admin que bloque√≥
  blockReason String?      // Motivo del bloqueo
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relaciones existentes
  shelter     Shelter?
  vendor      Vendor?
  adoptions   Adoption[]
  orders      Order[]
  favorites   Favorite[]
  
  // Auditor√≠a de acciones administrativas
  adminActions UserAudit[] @relation("AdminActions") // Acciones realizadas por este admin
  auditRecords UserAudit[] @relation("AffectedUser") // Auditor√≠as donde este usuario fue afectado

  @@index([role])
  @@index([isActive]) // √çndice para filtrar usuarios activos/bloqueados
  @@index([municipality])
  @@index([email])
}

model UserAudit {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Acci√≥n realizada
  action      AuditAction   // "BLOCK", "UNBLOCK", "CHANGE_ROLE", "DELETE"
  reason      String   // Justificaci√≥n obligatoria
  
  // Datos anteriores y nuevos (para trazabilidad)
  oldValue    String?  // Valor anterior (ej: "ADOPTER" en cambio de rol)
  newValue    String?  // Valor nuevo (ej: "VENDOR" en cambio de rol)
  
  // Relaciones
  performedBy User     @relation("AdminActions", fields: [adminId], references: [id], onDelete: Cascade)
  adminId     String   @db.ObjectId
  
  affectedUser User    @relation("AffectedUser", fields: [userId], references: [id], onDelete: Cascade)
  userId      String   @db.ObjectId
  
  // Metadata
  ipAddress   String?  // IP del admin (seguridad adicional)
  userAgent   String?  // Navegador del admin
  
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

model Shelter {
  id                String       @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  nit               String       @unique  // NIT √∫nico del albergue (DANE)
  municipality      Municipality
  address           String
  description       String?
  verified          Boolean      @default(false)
  contactWhatsApp   String?
  contactInstagram  String?
  rejectionReason   String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique @db.ObjectId

  pets Pet[]

  @@index([verified])
  @@index([municipality])
  @@index([name])
  @@index([nit])
}

model Vendor {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  businessName    String
  businessPhone   String?
  description     String?
  logo            String?
  municipality    Municipality
  address         String
  verified        Boolean      @default(false)
  rejectionReason String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique @db.ObjectId

  products Product[]

  @@index([verified])
  @@index([municipality])
  @@index([businessName])
}

model Pet {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  species      String
  breed        String?
  age          Int?
  sex          String?
  status       PetStatus @default(AVAILABLE)
  description  String
  requirements String?
  images       String[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  shelter   Shelter @relation(fields: [shelterId], references: [id], onDelete: Cascade)
  shelterId String  @db.ObjectId

  adoptions Adoption[]
  favorites Favorite[]

  @@index([status])
  @@index([species])
  @@index([shelterId])
  @@index([createdAt])
  @@index([name])
  @@index([sex])
  @@index([age])
}

model Product {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  price       Float
  stock       Int      @default(0)
  category    String
  description String?
  images      String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  vendor      Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId    String @db.ObjectId

  orderItems OrderItem[]

  @@index([category])
  @@index([vendorId])
  @@index([stock])
  @@index([name])
  @@index([price])
}

model Adoption {
  id        String          @id @default(auto()) @map("_id") @db.ObjectId
  status    AdoptionStatus  @default(PENDING)
  message   String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  adopter   User   @relation(fields: [adopterId], references: [id], onDelete: Cascade)
  adopterId String @db.ObjectId

  pet   Pet    @relation(fields: [petId], references: [id], onDelete: Cascade)
  petId String @db.ObjectId

  @@unique([adopterId, petId])
  @@index([status])
  @@index([adopterId])
  @@index([petId])
  @@index([createdAt])
}

model Order {
  id                   String       @id @default(auto()) @map("_id") @db.ObjectId
  status               OrderStatus  @default(PENDING)
  total                Float
  shippingMunicipality Municipality
  shippingAddress      String
  paymentMethod        String
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.ObjectId

  items OrderItem[]

  @@index([status])
  @@index([userId])
  @@index([shippingMunicipality])
  @@index([createdAt])
}

model OrderItem {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  quantity Int
  price    Float

  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId String @db.ObjectId

  product   Product @relation(fields: [productId], references: [id])
  productId String  @db.ObjectId

  @@index([orderId])
  @@index([productId])
}

model Favorite {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String   @db.ObjectId
  pet        Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)
  petId      String   @db.ObjectId

  @@unique([userId, petId])
  @@index([userId])
  @@index([petId])
  @@index([createdAt])
}

/**
 * üìö CAMBIOS APLICADOS EN ESTE SCHEMA:
 * 
 * 1. √çNDICES ADICIONALES PARA B√öSQUEDA (Performance - RNF-001):
 *    Pet:
 *    - @@index([name]) - B√∫squeda por nombre de mascota
 *    - @@index([sex]) - Filtro de g√©nero
 *    - @@index([age]) - Filtro de rango de edad
 *    
 *    Shelter:
 *    - @@index([name]) - B√∫squeda de albergues
 *    - @@index([nit]) - Validaci√≥n r√°pida de NIT
 *    
 *    Product:
 *    - @@index([name]) - B√∫squeda de productos
 *    - @@index([price]) - Ordenamiento por precio
 *    
 *    User:
 *    - @@index([email]) - Login frecuente
 *    - @@index([isActive]) - Filtrar usuarios bloqueados
 * 
 * 2. CAMPOS EXISTENTES PRESERVADOS:
 *    ‚úÖ User: isActive, blockedAt, blockedBy, blockReason (sistema de bloqueo HU-014)
 *    ‚úÖ UserAudit: Modelo completo de auditor√≠a (trazabilidad RN-017, RN-018)
 *    ‚úÖ Shelter: nit (NIT √∫nico del albergue - validaci√≥n legal)
 * 
 * 3. JUSTIFICACI√ìN DE √çNDICES DE B√öSQUEDA:
 *    - status: Siempre filtrado (AVAILABLE/ADOPTED)
 *    - species: Filtro principal de usuarios
 *    - shelterId: Join con shelter en cada query
 *    - createdAt: Ordenamiento por defecto (DESC)
 *    - name: B√∫squeda por nombre (pets, shelters, products)
 *    - sex: Filtro de g√©nero en b√∫squeda
 *    - age: Filtro de rango de edad (minAge/maxAge)
 *    - nit: Validaci√≥n de NIT duplicado
 * 
 * 4. IMPACTO EN PERFORMANCE (RNF-001):
 *    - B√∫squedas < 2 segundos con 10,000 registros
 *    - √çndices en RAM para queries frecuentes
 *    - MongoDB optimiza autom√°ticamente con $match pipeline
 * 
 * 5. COMPATIBILIDAD:
 *    ‚úÖ 100% compatible con c√≥digo existente
 *    ‚úÖ No rompe relaciones existentes
 *    ‚úÖ No modifica campos obligatorios
 *    ‚ö†Ô∏è NIT √∫nico puede fallar si hay shelters duplicados (resolver antes de migrar)
 */
